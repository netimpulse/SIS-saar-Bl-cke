{% comment %}
  Section: Leistung Suche Grid (ohne Karussell)
  - Suchfunktion über Titel + Keywords
  - 3 Spalten, außer exakt 4 sichtbare Karten -> 2 Spalten (2×2)
  - Keywords als runde Badges mit frei einstellbaren Farben
  - Jede Karte mit Button/Link
{% endcomment %}

{{ 'leistung-suche.css' | asset_url | stylesheet_tag }}

<section id="services-{{ section.id }}" class="services-grid-section"
  style="
    --badge-bg: {{ section.settings.keyword_badge_bg }};
    --badge-color: {{ section.settings.keyword_badge_color }};
    --card-bg: {{ section.settings.card_bg }};
    --card-radius: {{ section.settings.card_radius }}px;
    --card-shadow: {% if section.settings.card_shadow %}0 8px 24px rgba(0,0,0,.08){% else %}none{% endif %};
    --gap: {{ section.settings.grid_gap }}px;
  ">

  <div class="services-grid__inner page-width">
    {% if section.settings.heading != blank or section.settings.subheading != blank %}
      <div class="services-grid__header">
        {% if section.settings.heading != blank %}
          <h2 class="services-grid__title">{{ section.settings.heading }}</h2>
        {% endif %}
        {% if section.settings.subheading != blank %}
          <p class="services-grid__subtitle">{{ section.settings.subheading }}</p>
        {% endif %}
      </div>
    {% endif %}

    {% if section.settings.show_search %}
      <div class="services-grid__search">
        <input
          id="services-search-{{ section.id }}"
          type="search"
          class="services-grid__search-input"
          placeholder="{{ section.settings.search_placeholder | default: 'Suchen…' | escape }}"
          aria-label="{{ section.settings.search_placeholder | default: 'Suchen…' | escape }}"
        >
        <button type="button" class="services-grid__clear" aria-label="Suche löschen" hidden>×</button>
      </div>
    {% endif %}

    {%- assign total_items = section.blocks.size -%}
    <div
      class="services-grid"
      data-columns="{% if total_items == 4 %}2{% else %}3{% endif %}"
      data-section-id="{{ section.id }}"
      id="services-grid-{{ section.id }}"
    >
      {% for block in section.blocks %}
        {% render 'leistung-suche-card',
          id: block.id,
          image: block.settings.image,
          title: block.settings.title,
          text: block.settings.text,
          keywords: block.settings.keywords,
          button_label: block.settings.button_label,
          button_link: block.settings.button_link,
          badge_style: section.settings.badge_style,
          button_style: section.settings.button_style
        %}
      {% endfor %}
    </div>

    {% if section.settings.show_cta and section.settings.cta_label != blank and section.settings.cta_link != blank %}
      <div class="services-grid__footer">
        <a class="services-grid__cta btn btn--{{ section.settings.button_style }}" href="{{ section.settings.cta_link }}">
          {{ section.settings.cta_label }}
        </a>
      </div>
    {% endif %}
  </div>

  <script>
    (function() {
      const root = document.getElementById('services-{{ section.id }}');
      if (!root) return;

      const grid = root.querySelector('.services-grid');
      const input = root.querySelector('.services-grid__search-input');
      const clearBtn = root.querySelector('.services-grid__clear');

      function normalize(s){ return (s || '').toString().toLowerCase().trim(); }

      function applyFilter(q) {
        const query = normalize(q);
        const cards = grid.querySelectorAll('[data-service-card]');
        let visibleCount = 0;
        cards.forEach(card => {
          const hay = card.getAttribute('data-search-haystack');
          const match = !query || hay.includes(query);
          card.style.display = match ? '' : 'none';
          if (match) visibleCount++;
        });

        // Layout-Regel: Genau 4 sichtbare -> 2 Spalten; sonst 3 Spalten
        grid.setAttribute('data-columns', visibleCount === 4 ? '2' : '3');
      }

      if (input) {
        input.addEventListener('input', (e)=>{
          const value = e.target.value;
          clearBtn && clearBtn.toggleAttribute('hidden', !value.length);
          applyFilter(value);
        });
      }
      if (clearBtn) {
        clearBtn.addEventListener('click', ()=>{
          input.value = '';
          clearBtn.setAttribute('hidden','');
          applyFilter('');
          input.focus();
        });
      }

      // Initial
      applyFilter(input ? input.value : '');
    })();
  </script>
</section>

{% schema %}
{
  "name": "Leistung Suche Grid",
  "tag": "section",
  "class": "section",
  "settings": [
    { "type": "text", "id": "heading", "label": "Leistung Suche Überschrift", "default": "Unsere Leistungen" },
    { "type": "text", "id": "subheading", "label": "Leistung Suche Untertitel", "default": "Mit Leidenschaft für Ihren Erfolg." },

    { "type": "checkbox", "id": "show_search", "label": "Leistung Suche Feld anzeigen", "default": true },
    { "type": "text", "id": "search_placeholder", "label": "Leistung Suche Suchfeld Placeholder", "default": "Leistungen oder Keywords suchen…" },

    { "type": "select", "id": "badge_style", "label": "Leistung Suche Badge Stil", "default": "solid",
      "options": [
        { "value": "solid", "label": "Voll" },
        { "value": "outline", "label": "Outline" }
      ]
    },
    { "type": "color", "id": "keyword_badge_bg", "label": "Leistung Suche Badge Hintergrund", "default": "#E6F0FF" },
    { "type": "color", "id": "keyword_badge_color", "label": "Leistung Suche Badge Text", "default": "#0F1C3F" },

    { "type": "color", "id": "card_bg", "label": "Leistung Suche Kachel Hintergrund", "default": "#ffffff" },
    { "type": "range", "id": "card_radius", "min": 0, "max": 28, "step": 2, "unit": "px", "label": "Leistung Suche Kachel-Radius", "default": 18 },
    { "type": "checkbox", "id": "card_shadow", "label": "Leistung Suche Kachel-Schatten", "default": true },
    { "type": "range", "id": "grid_gap", "min": 8, "max": 40, "step": 2, "unit": "px", "label": "Leistung Suche Abstand Kacheln", "default": 20 },

    { "type": "header", "content": "Leistung Suche CTA (optional)" },
    { "type": "checkbox", "id": "show_cta", "label": "Leistung Suche CTA anzeigen", "default": false },
    { "type": "text", "id": "cta_label", "label": "Leistung Suche CTA-Text", "default": "Mehr erfahren" },
    { "type": "url", "id": "cta_link", "label": "Leistung Suche CTA-Link" },

    { "type": "select", "id": "button_style", "label": "Leistung Suche Button-Stil", "default": "primary",
      "options": [
        { "value": "primary", "label": "Primär" },
        { "value": "secondary", "label": "Sekundär" },
        { "value": "link", "label": "Link-Style" }
      ]
    }
  ],
  "blocks": [
    {
      "type": "service",
      "name": "Leistung Suche Block",
      "settings": [
        { "type": "image_picker", "id": "image", "label": "Leistung Suche Bild" },
        { "type": "text", "id": "title", "label": "Leistung Suche Titel", "default": "Unterhaltsreinigung" },
        { "type": "textarea", "id": "text", "label": "Leistung Suche Kurzbeschreibung", "default": "Kurze Beschreibung hier." },
        { "type": "text", "id": "keywords", "label": "Leistung Suche Keywords (Kommagetrennt)", "default": "Büro, täglich, flexibel" },
        { "type": "text", "id": "button_label", "label": "Leistung Suche Button-Text", "default": "Mehr erfahren" },
        { "type": "url", "id": "button_link", "label": "Leistung Suche Button-Link" }
      ]
    }
  ],
  "max_blocks": 24,
  "presets": [
    { "name": "Leistung Suche Grid", "category": "Abschnitte" }
  ]
}
{% endschema %}
