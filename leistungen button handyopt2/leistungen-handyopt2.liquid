{% comment %}
Section "Leistungen Handyopt2" – mobil optimiert (Carousel + Snap + Arrows)
{% endcomment %}

{{ 'leistungen-handyopt2.css' | asset_url | stylesheet_tag }}

<section id="leistungen-handyopt2-{{ section.id }}" class="leistungen-handyopt2" data-section-id="{{ section.id }}">
  {%- if section.settings.heading != blank -%}
    <header class="leistungen-neu-heading">
      <h2>{{ section.settings.heading }}</h2>
      {%- if section.settings.kicker != blank -%}
        <p class="leistungen-button-cta__kicker">{{ section.settings.kicker }}</p>
      {%- endif -%}
    </header>
  {%- endif -%}

  <div class="carousel-wrapper" data-carousel>
    <button class="carousel-arrow carousel-arrow--prev" type="button" aria-label="Zurück" data-prev>
      <!-- simple chevron left -->
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
    </button>

    <div class="carousel-viewport" data-viewport>
      <div class="carousel-track" data-track>
        {%- for block in section.blocks -%}
          <div class="carousel-slide" {{ block.shopify_attributes }}>
            {% render 'leistungen-handyopt2-block', block: block %}
          </div>
        {%- endfor -%}
      </div>
    </div>

    <button class="carousel-arrow carousel-arrow--next" type="button" aria-label="Weiter" data-next>
      <!-- simple chevron right -->
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M8.59 16.59 10 18l6-6-6-6-1.41 1.41L13.17 12z"/></svg>
    </button>
  </div>

  {%- if section.settings.cta_label != blank and section.settings.cta_url != blank -%}
    <div class="leistungen-button-cta">
      <a class="leistungen-button-cta__btn" href="{{ section.settings.cta_url }}" {% if section.settings.cta_new_tab %}target="_blank" rel="noopener noreferrer"{% endif %}>
        {{ section.settings.cta_label }}
      </a>
    </div>
  {%- endif -%}
</section>

{% javascript %}
(function() {
  const root = document.getElementById('leistungen-handyopt2-{{ section.id }}');
  if (!root) return;

  const viewport = root.querySelector('[data-viewport]');
  const track = root.querySelector('[data-track]');
  const prev = root.querySelector('[data-prev]');
  const next = root.querySelector('[data-next]');

  if (!viewport || !track || !prev || !next) return;

  // Scroll by one slide width (desktop) or viewport width * 0.85 (fallback)
  function getStep() {
    const firstSlide = track.querySelector('.carousel-slide');
    if (firstSlide) return firstSlide.getBoundingClientRect().width;
    return Math.max(1, Math.floor(viewport.clientWidth * 0.85));
  }

  function scrollByStep(dir) {
    const step = getStep();
    viewport.scrollBy({ left: dir * step, behavior: 'smooth' });
  }

  prev.addEventListener('click', () => scrollByStep(-1));
  next.addEventListener('click', () => scrollByStep(1));

  // Disable arrows at ends for accessibility (when snap used with overflow)
  function updateArrowState() {
    const maxScroll = viewport.scrollWidth - viewport.clientWidth - 1;
    prev.disabled = viewport.scrollLeft <= 0;
    next.disabled = viewport.scrollLeft >= maxScroll;
  }

  viewport.addEventListener('scroll', updateArrowState, { passive: true });
  window.addEventListener('resize', updateArrowState);

  // Init
  updateArrowState();
})();
{% endjavascript %}

{% schema %}
{
  "name": "Leistungen – Handyopt2",
  "settings": [
    { "type": "text", "id": "heading", "label": "Überschrift", "default": "Unsere Leistungen" },
    { "type": "text", "id": "kicker", "label": "Kicker (optional)" },
    { "type": "text", "id": "cta_label", "label": "CTA-Label", "default": "Jetzt beraten lassen" },
    { "type": "url",  "id": "cta_url", "label": "CTA-Link" },
    { "type": "checkbox", "id": "cta_new_tab", "label": "CTA in neuem Tab öffnen", "default": false }
  ],
  "blocks": [
    {
      "type": "leistungen_handyopt2",
      "name": "Leistung (Handyopt2)",
      "settings": [
        { "type": "image_picker", "id": "main_image", "label": "Hauptbild" },
        { "type": "image_picker", "id": "number_icon", "label": "Nummern-Icon (optional)" },
        { "type": "text", "id": "title", "label": "Titel" },
        { "type": "text", "id": "subtitle", "label": "Untertitel" },
        { "type": "richtext", "id": "text", "label": "Text" }
      ]
    }
  ],
  "presets": [
    { "name": "Leistungen – Handyopt2", "category": "Abschnitte" }
  ]
}
{% endschema %}
