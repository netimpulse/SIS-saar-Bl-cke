{% comment %}
  Downloads – Section
  - Fügt ein Suchfeld (Titel & Tags), Grid mit Kacheln (Bild zeigt das hinterlegte Dokument)
  - Bild + Button laden die Datei per "download" Attribut herunter
  - Nutzt das Snippet 'download-card'
  - CSS wird automatisch eingebunden (assets/downloads.css)
{% endcomment %}

{{ 'downloads.css' | asset_url | stylesheet_tag }}

<section id="downloads-{{ section.id }}" class="downloads-section">
  <div class="downloads-header container">
    {% if section.settings.heading != blank %}
      <h2 class="downloads-heading"
          style="
            color: {{ section.settings.text_color }};
            font-size: {{ section.settings.font_size }}px;
            {% if section.settings.font_family != 'theme' %}font-family: {{ section.settings.font_family }}, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;{% endif %}
          ">
        {{ section.settings.heading | escape }}
      </h2>
    {% endif %}

    {% if section.settings.subtext != blank %}
      <div class="downloads-subtext rte"
           style="
             color: {{ section.settings.text_color }};
             font-size: {{ section.settings.subtext_size }}px;
             {% if section.settings.font_family != 'theme' %}font-family: {{ section.settings.font_family }}, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;{% endif %}
           ">
        {{ section.settings.subtext }}
      </div>
    {% endif %}

    {% if section.settings.show_search %}
      <div class="downloads-search">
        <input type="text"
               id="downloads-search-{{ section.id }}"
               class="downloads-search__input"
               placeholder="{{ section.settings.search_placeholder | escape }}"
               aria-label="{{ section.settings.search_placeholder | escape }}">
        <p class="downloads-search__hint">{{ section.settings.search_hint }}</p>
      </div>
    {% endif %}
  </div>

  <div class="downloads-grid container" id="downloads-grid-{{ section.id }}">
    {% for block in section.blocks %}
      {% render 'download-card',
        title: block.settings.title,
        date: block.settings.date,
        image: block.settings.image,
        file_url: block.settings.file_url,
        tags: block.settings.tags,
        accent_color: section.settings.hover_color,
        section_id: section.id,
        block: block
      %}
    {% endfor %}
  </div>

  {% if section.blocks.size == 0 %}
    <div class="container">
      <p class="downloads-empty">{{ 'Füge im Theme-Editor Blöcke hinzu, um Downloads zu zeigen.' }}</p>
    </div>
  {% endif %}
</section>

<script>
  (function() {
    const sectionId = '{{ section.id }}';
    const input = document.getElementById('downloads-search-' + sectionId);
    const grid  = document.getElementById('downloads-grid-' + sectionId);
    if (!grid) return;

    // click on tag pill => write into search and trigger
    grid.addEventListener('click', function(e){
      const pill = e.target.closest('[data-tag-pill]');
      if (!pill || !input) return;
      const tag = pill.getAttribute('data-tag-pill');
      // toggle simple tag token in input (comma separated)
      const tokens = input.value.split(',').map(t => t.trim()).filter(Boolean);
      const idx = tokens.findIndex(t => t.toLowerCase() === tag.toLowerCase());
      if (idx >= 0) { tokens.splice(idx,1); } else { tokens.push(tag); }
      input.value = tokens.join(', ');
      filter();
    });

    function normalize(str){ return (str || '').toLowerCase(); }

    function filter() {
      const query = normalize(input ? input.value : '');
      // tokens split by comma OR space
      const tokens = query.split(/[, ]+/).filter(Boolean);
      const cards = grid.querySelectorAll('[data-dl-card]');
      cards.forEach(card => {
        const hay = card.getAttribute('data-search-haystack');
        if (!tokens.length) {
          card.style.display = '';
          return;
        }
        const ok = tokens.every(t => hay.indexOf(t) > -1);
        card.style.display = ok ? '' : 'none';
      });
    }

    // debounce input
    let t=null;
    if (input){
      input.addEventListener('input', function(){
        clearTimeout(t);
        t = setTimeout(filter, 120);
      });
    }
  })();
</script>

{% schema %}
{
  "name": "Downloads / Zertifikate",
  "settings": [
    { "type": "text", "id": "heading", "label": "Überschrift", "default": "Downloads" },
    { "type": "richtext", "id": "subtext", "label": "Kurzer Text über den Kacheln",
      "default": "<p>Hier finden Sie unsere Zertifikate, Broschüren und weitere Unterlagen. Klicken Sie auf eine Kachel oder den Button, um die Datei herunterzuladen.</p>"
    },
    { "type": "color", "id": "text_color", "label": "Textfarbe", "default": "#111111" },
    { "type": "range", "id": "font_size", "min": 14, "max": 56, "step": 1, "unit": "px", "label": "Überschrift Größe", "default": 34 },
    { "type": "range", "id": "subtext_size", "min": 12, "max": 28, "step": 1, "unit": "px", "label": "Textgröße", "default": 16 },
    { "type": "select", "id": "font_family", "label": "Schriftart (optional überschreiben)",
      "default": "theme",
      "options": [
        { "value": "theme", "label": "Theme-Standard" },
        { "value": "Inter", "label": "Inter" },
        { "value": "Arial", "label": "Arial" },
        { "value": "Georgia", "label": "Georgia" },
        { "value": "Times New Roman", "label": "Times New Roman" }
      ]
    },
    { "type": "checkbox", "id": "show_search", "label": "Suchfunktion mit Tags anzeigen", "default": true },
    { "type": "text", "id": "search_placeholder", "label": "Platzhalter für Suche", "default": "Suchen… (Titel oder Tags, z. B. ISO, VDI, Brandschutz)" },
    { "type": "text", "id": "search_hint", "label": "Hilfetext unter Suche", "default": "Tipp: Mehrere Tags mit Komma trennen – z. B. “ISO, 9001”" },
    { "type": "color", "id": "hover_color", "label": "Hover-Farbe", "default": "#e6f4ff" }
  ],
  "blocks": [
    {
      "type": "download",
      "name": "Download-Kachel",
      "settings": [
        { "type": "text", "id": "title", "label": "Titel", "default": "ISO 9001" },
        { "type": "text", "id": "date", "label": "Datum (optional)", "default": "11.09.2023" },
        { "type": "image_picker", "id": "image", "label": "Vorschaubild (zeigt das Dokument)" },
        { "type": "url", "id": "file_url", "label": "Datei-URL (PDF, Bild, etc.)" },
        { "type": "text", "id": "tags", "label": "Tags (Kommagetrennt)", "default": "Zertifikat, ISO, 9001" }
      ]
    }
  ],
  "presets": [
    { "name": "Downloads / Zertifikate", "category": "Abschnitte" }
  ]
}
{% endschema %}
